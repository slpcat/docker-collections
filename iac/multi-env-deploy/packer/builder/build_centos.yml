variables:
  app: "{{env `APP`}}"
  comp: "{{env `COMP`}}"
  env: "{{env `ENV`}}"
  aws_region: "{{env `AWS_REGION`}}"
  aws_vpc: "{{env `AWS_VPC`}}"
  aws_subnet: "{{env `AWS_SUBNET`}}"
  aws_security_group: "{{env `AWS_SECURITY_GROUP`}}"
  aws_ami: "{{env `AWS_AMI`}}"
  aws_instance_type: "{{env `AWS_INSTANCE_TYPE`}}"
  aws_iam_instance_profile: "{{env `AWS_IAM_INSTANCE_PROFILE`}}"
  ansible_vault_pass: "{{env `ANSIBLE_VAULT_PASS`}}"
  ansible_playbook_file: "{{env `ANSIBLE_PLAYBOOK_FILE`}}"
  ansible_playbook_dir: "{{env `ANSIBLE_PLAYBOOK_DIR`}}"
  ansible_group_vars_dir: "{{env `ANSIBLE_GROUP_VARS_DIR`}}"
  ansible_extra_arguments: "{{env `ANSIBLE_EXTRA_ARGUMENTS`}}"
  ansible_extra_vars: "{{env `ANSIBLE_EXTRA_VARS`}}"
builders:
  - type: "amazon-ebs"
    region: "{{user `aws_region`}}"
    source_ami: "{{ user `aws_ami` }}"
    iam_instance_profile: "{{user `aws_iam_instance_profile`}}"
    instance_type: "{{ user `aws_instance_type` }}"
    ssh_username: "centos"
    ami_name: "{{user `app`}} {{user `env`}} {{user `comp`}} {{timestamp}}"
    vpc_id: "{{user `aws_vpc`}}"
    subnet_id: "{{user `aws_subnet`}}"
    security_group_id: "{{user `aws_security_group`}}"
    associate_public_ip_address: "true"
    ami_virtualization_type: "hvm"
    communicator: "ssh"
    ssh_pty: "true"
    launch_block_device_mappings:
      - device_name: "/dev/sda1"
        volume_size: 8
        volume_type: "gp2"
        delete_on_termination: true
provisioners:
  - type: "shell"
    inline:
      - "sudo yum install -y epel-release"
      #- "sudo yum update -q -y"
      #- "sudo yum install -y python36"
      #- "sudo which python36"
      #- "sudo ln -s /bin/pyhton36 /usr/bin/python3"
      - "sudo yum install -y ansible --enablerepo=epel"
      # - "sudo yum install -q -y awscli"
  - type: "ansible-local"
    playbook_dir: "{{user `ansible_playbook_dir`}}"
    playbook_file: "{{user `ansible_playbook_file`}}"
    inventory_groups: "tag_app_{{user `app`}},tag_env_{{user `env`}},tag_comp_{{user `comp`}}"
    group_vars: "{{user `ansible_group_vars_dir`}}"
    command: "echo '{{user `ansible_vault_pass`}}' | ansible-playbook"
    extra_arguments:
      - "--vault-password-file=/bin/cat"
      - "{{user `ansible_extra_arguments`}}"
      - "--extra-vars \"{{user `ansible_extra_vars`}}\""
